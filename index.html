<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>能源快跑</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

        <!-- 在<head>中添加以下内容 -->
        <link rel="preload" href="https://i.imgur.com/0HmSQpo.png" as="image">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #e0f2f1, #fff);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }
        canvas {
            display: block;
            margin: auto;
            background: #c8e6c9;
            border: 4px solid #388e3c;
            border-radius: 10px;
            width: 100%;
            height: 70vh;
            max-height: 500px;
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            font-size: 1em;
            color: #2e7d32;
            z-index: 5;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #pauseStatus { display: none; }
        #startScreen, #endScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        #startScreen h1, #endScreen h2 {
            color: #388e3c;
            margin-bottom: 20px;
            font-size: 2em;
        }
        #startScreen p, #endScreen p {
            margin-bottom: 30px;
            font-size: 1.2em;
            color: #555;
            max-width: 80%;
        }
        #startScreen button, #endScreen button {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        #startScreen button:active, #endScreen button:active {
            transform: scale(0.95);
        }
        #controls {
            position: fixed;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 0 20px;
            z-index: 5;
        }

        #leftBtn, #rightBtn {
            width: 70px;
            height: 70px;
            background-color: rgba(102, 187, 106, 0.8);
            backdrop-filter: blur(5px);
            border: 2px solid white;
        }

        #jumpBtn {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 152, 0, 0.8);
            backdrop-filter: blur(5px);
            border: 2px solid white;
        }

        /* 添加按钮图标样式 */
        #leftBtn::before {
            content: "←";
            font-size: 24px;
        }

        #rightBtn::before {
            content: "→";
            font-size: 24px;
        }

        #jumpBtn::before {
            content: "↑";
            font-size: 24px;
        }
        /* 选择题弹窗 */
        #questionModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fff;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        #questionText {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 1.3em;
            line-height: 1.4;
            text-align: center;
        }
        .option {
            display: block;
            margin: 10px 0;
            padding: 12px;
            width: 100%;
            background-color: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
        }
        .option:active {
            background-color: #e8f5e9;
            border-color: #81c784;
        }
        .option.selected {
            background-color: #c8e6c9;
            border-color: #388e3c;
            color: #2e7d32;
            font-weight: bold;
        }
        #submitAnswer {
            margin-top: 20px;
            padding: 12px;
            width: 100%;
            font-size: 1.1em;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #submitAnswer:active {
            background-color: #2e7d32;
        }

        /* 游戏容器 */
        #gameContainer {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 10px;
        }

        /* 提示信息 */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            z-index: 300;
            display: none;
            font-size: 1.1em;
            text-align: center;
            max-width: 80%;
        }

        /* 全屏提示 */
        #fullscreenPrompt {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 50;
            font-size: 0.9em;
            display: none;
        }
        @media (max-width: 480px) {
            #controls {
                bottom: 15px;
                gap: 15px;
            }

            #leftBtn, #rightBtn {
                width: 60px;
                height: 60px;
            }

            #jumpBtn {
                width: 70px;
                height: 70px;
            }
        }

        /* 横屏模式调整 */
        @media (orientation: landscape) {
            #controls {
                bottom: 10px;
            }

            canvas {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
<div id="gameContainer">
    <div id="hud">
        <div id="scoreboard">得分：0</div>
        <div id="timer">时间：60秒</div>
        <div id="pauseStatus">暂停中</div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="fullscreenPrompt">点击任意位置全屏游玩</div>
</div>

<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2023/03/27/audio_1dc7e4d0fd.mp3?filename=arcade-112336.mp3" loop></audio>
<audio id="jumpSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_a326c93f3f.mp3"></audio>

<div id="startScreen">
    <h1>能源快跑</h1>
    <p>回答节能知识问题，收集能量，挑战最高分！</p>
    <button id="startButton">开始游戏</button>
</div>

<div id="controls">
    <button id="leftBtn">←</button>
    <button id="jumpBtn">↑</button>
    <button id="rightBtn">→</button>
</div>

<div id="questionModal">
    <div class="modal-content">
        <h3 id="questionText"></h3>
        <div id="optionsContainer"></div>
        <button id="submitAnswer">提交答案</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    // 游戏元素
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreboard = document.getElementById('scoreboard');
    const timerDisplay = document.getElementById('timer');
    const pauseStatus = document.getElementById('pauseStatus');
    const startScreen = document.getElementById('startScreen');
    const startButton = document.getElementById('startButton');
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const jumpBtn = document.getElementById('jumpBtn');
    const jumpSound = document.getElementById('jumpSound');
    const fullscreenPrompt = document.getElementById('fullscreenPrompt');
    const toast = document.getElementById('toast');

    // 游戏变量
    let player = {}, items = [], gameFrame, spawnTimer, countdown;
    let ground, gravity = 0.5, speed = 3;
    let score = 0, timeLeft = 60, paused = false, gameRunning = false;
    let isFullscreen = false;
    let currentModalItem = null;
    let selectedOption = null;

    // 节能题库
    const questions = [
        { q: '以下哪项是节能行为？', options: ['整晚开灯', '白天利用自然光', '冰箱门常开'], correct: 1 },
        { q: '以下哪项更节能？', options: ['空教室开空调', '拔掉电器插头', '电脑不休眠'], correct: 1 },
        { q: '频繁开关冰箱会怎样？', options: ['省电', '加快制冷', '浪费能源'], correct: 2 },
        { q: '哪种行为更节能？', options: ['将饭菜反复加热', '合理安排用餐量', '长期开灯做作业'], correct: 1 },
        { q: '如何节约空调能耗？', options: ['经常开关', '调至最低温度', '设定合理温度并定期清洗过滤网'], correct: 2 },
        { q: '用电脑后应怎样节能？', options: ['随时关机', '待机不断电', '开启节能模式并及时关闭显示器'], correct: 2 },
        { q: '洗衣更节能的做法是？', options: ['多次少量洗', '集中洗涤、满载使用', '用热水漂洗'], correct: 1 },
        { q: '校园中哪个用电行为应避免？', options: ['空教室灯全开', '走廊传感灯', '公共区域定时照明'], correct: 0 },
        { q: '下列哪种设备最省电？', options: ['白炽灯', '节能灯', '高压钠灯'], correct: 1 },
        { q: '合理安排作息可带来什么节能效果？', options: ['避免夜间照明', '避免清晨活动', '提升能耗'], correct: 0 },
        { q: '以下哪项是绿色出行方式？', options: ['打车', '拼车', '骑自行车'], correct: 2 },
        { q: '教室节能应采取哪种做法？', options: ['下课忘关灯', '随手关灯', '白天也开灯'], correct: 1 },
        { q: '夏天使用空调最合理的温度设置是？', options: ['18℃', '20℃', '26℃'], correct: 2 },
        { q: '充电完成后应做什么？', options: ['继续充电', '拔掉充电器', '无所谓'], correct: 1 },
        { q: '什么样的照明方式更节能？', options: ['集中照明', '过度照明', '边走边开灯'], correct: 0 },
        { q: '在宿舍节能应该避免什么行为？', options: ['电脑挂着下载通宵', '统一作息关灯', '使用节能插座'], correct: 0 }
    ];

    // 初始化游戏
    function initGame() {
        resizeCanvas();
        resetGameState();

        // 显示全屏提示
        if (!document.fullscreenElement) {
            fullscreenPrompt.style.display = 'block';
            setTimeout(() => {
                fullscreenPrompt.style.display = 'none';
            }, 3000);
        }

        // 点击任意位置进入全屏
        document.addEventListener('click', requestFullscreen);
    }

    // 请求全屏
    function requestFullscreen() {
        if (!document.fullscreenElement) {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen().catch(err => {
                    showToast('全屏模式失败: ' + err.message);
                });
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }
        document.removeEventListener('click', requestFullscreen);
    }

    // 调整画布大小
    function resizeCanvas() {
        const width = Math.min(window.innerWidth, 500);
        const height = Math.min(window.innerHeight * 0.7, 500);

        canvas.width = width;
        canvas.height = height;

        // 设置地面位置
        ground = height - 50;
    }

    // 重置游戏状态
    function resetGameState() {
        player = {
            x: 50,
            y: ground - 60,
            width: 50,
            height: 60,
            vy: 0,
            jump: false,
            speed: 4,
            movingLeft: false,
            movingRight: false
        };

        score = 0;
        timeLeft = 60;
        paused = false;
        items = [];
        gameRunning = true;

        scoreboard.innerText = `得分：${score}`;
        timerDisplay.innerText = `时间：${timeLeft}秒`;
        pauseStatus.style.display = 'none';
    }

    // 生成题目物品
    function spawnItem() {
        if (Math.random() < 0.6) {
            let q = questions[Math.floor(Math.random() * questions.length)];
            items.push({
                x: canvas.width + 100,
                y: ground - 40,
                width: 40,
                height: 40,
                question: q,
                answered: false,
                passed: false
            });
        }
    }

    // 绘制玩家
    // 在游戏变量部分添加
    let playerImg = new Image();
    playerImg.src = 'https://i.imgur.com/0HmSQpo.png'; // 替换为你的图片路径

    // 修改drawPlayer函数
    function drawPlayer() {
        if (playerImg.complete) {
            ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
        } else {
            // 备用绘制方案（图片未加载时）
            ctx.fillStyle = '#2196F3';
            ctx.beginPath();
            ctx.roundRect(player.x, player.y, player.width, player.height, 10);
            ctx.fill();
        }
    }

    // 绘制物品
    function drawItems() {
        ctx.fillStyle = '#FF9800';
        items.forEach(item => {
            ctx.beginPath();
            ctx.roundRect(item.x, item.y, item.width, item.height, 8);
            ctx.fill();

            // 绘制问号
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('?', item.x + item.width/2, item.y + item.height/2);
            ctx.fillStyle = '#FF9800';
        });
    }

    // 更新物品位置
    function updateItems() {
        items.forEach(item => {
            item.x -= speed;
            if (!item.answered && !item.passed && item.x + item.width < player.x) {
                score += 10;
                item.passed = true;
                scoreboard.innerText = `得分：${score}`;
            }
        });
        items = items.filter(item => item.x + item.width > 0);
    }

    // 检测碰撞
    function checkCollision() {
        items.forEach(item => {
            if (!item.answered &&
                player.x < item.x + item.width &&
                player.x + player.width > item.x &&
                player.y < item.y + item.height &&
                player.y + player.height > item.y) {
                showQuestionModal(item);
                item.answered = true;
                player.movingLeft = false;
                player.movingRight = false;
            }
        });
    }

    // 显示问题弹窗
    function showQuestionModal(item) {
        currentModalItem = item;
        selectedOption = null;
        const modal = document.getElementById('questionModal');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const submitButton = document.getElementById('submitAnswer');

        questionText.innerText = item.question.q;
        optionsContainer.innerHTML = '';

        // 创建选项按钮
        item.question.options.forEach((option, index) => {
            const optionElement = document.createElement('button');
            optionElement.className = 'option';
            optionElement.textContent = option;
            optionElement.dataset.index = index;

            optionElement.addEventListener('click', function() {
                // 移除之前选中的样式
                document.querySelectorAll('.option').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // 添加选中样式
                this.classList.add('selected');
                selectedOption = parseInt(this.dataset.index);
            });

            optionsContainer.appendChild(optionElement);
        });

        modal.style.display = 'flex';

        // 暂停游戏
        paused = true;
        pauseStatus.style.display = 'block';

        // 清除旧的点击事件
        submitButton.onclick = null;

        // 添加新的点击事件
        submitButton.onclick = () => {
            if (selectedOption === null) {
                showToast('请选择一个答案！');
                return;
            }

            if (selectedOption === item.question.correct) {
                score += 10;
                showToast('回答正确！+10分', 1500);
            } else {
                score -= 5;
                showToast(`回答错误！-5分 (正确答案: ${item.question.options[item.question.correct]})`, 2000);
            }

            scoreboard.innerText = `得分：${score}`;
            modal.style.display = 'none';

            // 恢复游戏
            paused = false;
            pauseStatus.style.display = 'none';

            // 重新开始游戏循环
            if (gameRunning) {
                gameLoop();
            }
        };
    }

    // 显示提示信息
    function showToast(message, duration = 1500) {
        toast.textContent = message;
        toast.style.display = 'block';

        setTimeout(() => {
            toast.style.display = 'none';
        }, duration);
    }

    // 显示结束画面
    function showEndScreen() {
        gameRunning = false;
        cancelAnimationFrame(gameFrame);
        clearInterval(spawnTimer);
        clearInterval(countdown);

        const endScreen = document.createElement('div');
        endScreen.id = 'endScreen';
        endScreen.innerHTML = `
            <h2>游戏结束</h2>
            <p>你的得分是：<strong>${score}</strong></p>
            <button id="restartBtn">再来一局</button>
        `;
        document.body.appendChild(endScreen);

        document.getElementById('restartBtn').onclick = () => {
            document.body.removeChild(endScreen);
            startGame();
        };
    }

    // 游戏主循环
    function gameLoop() {
        if (!gameRunning || paused) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 绘制背景
        ctx.fillStyle = '#a5d6a7';
        ctx.fillRect(0, ground, canvas.width, canvas.height - ground);

        // 绘制天空
        ctx.fillStyle = '#e0f7fa';
        ctx.fillRect(0, 0, canvas.width, ground);

        // 绘制云朵
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        for (let i = 0; i < 3; i++) {
            const x = (Date.now() / 1000 * 20 + i * 200) % (canvas.width + 100) - 50;
            const y = 50 + i * 60;
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y - 10, 25, 0, Math.PI * 2);
            ctx.arc(x + 50, y, 15, 0, Math.PI * 2);
            ctx.fill();
        }

        // 更新玩家位置
        player.y += player.vy;
        player.vy += gravity;
        if (player.y > ground - player.height) {
            player.y = ground - player.height;
            player.vy = 0;
            player.jump = false;
        }

        if (player.movingLeft && player.x > 0) player.x -= player.speed;
        if (player.movingRight && player.x + player.width < canvas.width) player.x += player.speed;

        drawPlayer();
        updateItems();
        drawItems();
        checkCollision();

        gameFrame = requestAnimationFrame(gameLoop);
    }

    // 开始游戏
    function startGame() {
        resetGameState();
        startScreen.style.display = 'none';

        gameLoop();

        spawnTimer = setInterval(() => {
            if (!paused && gameRunning) spawnItem();
        }, 1800);

        countdown = setInterval(() => {
            if (!paused && gameRunning) {
                timeLeft--;
                timerDisplay.innerText = `时间：${timeLeft}秒`;
                if (timeLeft <= 0) showEndScreen();
            }
        }, 1000);

        // 尝试播放背景音乐
        try {
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play().catch(e => {
                console.log('自动播放被阻止:', e);
                showToast('点击屏幕解锁音频播放');
            });
        } catch (e) {
            console.log('音频错误:', e);
        }
    }

    // 事件监听
    startButton.addEventListener('click', startGame);

    // 触摸控制
    leftBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        player.movingLeft = true;
    });
    leftBtn.addEventListener('touchend', () => player.movingLeft = false);
    leftBtn.addEventListener('touchcancel', () => player.movingLeft = false);

    rightBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        player.movingRight = true;
    });
    rightBtn.addEventListener('touchend', () => player.movingRight = false);
    rightBtn.addEventListener('touchcancel', () => player.movingRight = false);

    jumpBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (!player.jump) {
            player.vy = -12;
            player.jump = true;
            jumpSound.play().catch(e => console.log('跳跃音效错误:', e));
        }
    });

    // 键盘控制
    document.addEventListener('keydown', e => {
        if (e.code === 'Space' && !player.jump) {
            player.vy = -12;
            player.jump = true;
            jumpSound.play().catch(e => console.log('跳跃音效错误:', e));
        }
        if (e.code === 'KeyA' || e.code === 'ArrowLeft') player.movingLeft = true;
        if (e.code === 'KeyD' || e.code === 'ArrowRight') player.movingRight = true;
    });

    document.addEventListener('keyup', e => {
        if (e.code === 'KeyA' || e.code === 'ArrowLeft') player.movingLeft = false;
        if (e.code === 'KeyD' || e.code === 'ArrowRight') player.movingRight = false;
    });

    // 窗口大小变化时调整画布
    window.addEventListener('resize', () => {
        resizeCanvas();
        if (gameRunning) {
            player.y = ground - player.height;
        }
    });

    // 点击解锁音频
    document.addEventListener('click', () => {
        try {
            const bgm = document.getElementById('bgm');
            if (bgm.paused) {
                bgm.play().catch(e => console.log('音频播放错误:', e));
            }
        } catch (e) {
            console.log('音频错误:', e);
        }
    }, { once: true });

    // 初始化游戏
    initGame();
</script>
</body>
</html>